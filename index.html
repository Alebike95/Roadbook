<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roadbook Logger</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --card:#121826;
  --muted:#9fb0c3;
  --btn:#1b2536;
  --line:#223;
  --ok:#4dd4ac;
  --warn:#ffcc66;
}

body{margin:0;background:var(--bg);color:#e8eef6;font-family:system-ui}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px}

.top-row{
  display:flex;
  gap:8px;
  align-items:stretch;
}

.trip-card{
  flex:1;
}

.photo-btn{
  width:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  cursor:pointer;
  background:var(--btn);
  border-radius:14px;
}

.big{
  font-size:56px;
  font-family:monospace;
  line-height:1;
  text-align:right;
  padding-right:2ch;
}

.label{font-size:11px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

button{
  background:var(--btn);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:12px;
}

.gps-bar{
  display:flex;
  align-items:center;
  gap:8px;
}

.gps-info{
  flex:1;
  display:flex;
  gap:10px;
  justify-content:center;
  white-space:nowrap;
}

#recBtn.rec{color:var(--ok)}
#recBtn.pause{color:var(--warn)}

#map{
  height:320px;
  border-radius:14px;
  position:relative;
}

#recenter{
  position:absolute;
  bottom:12px;
  right:12px;
  z-index:2000;
  background:var(--btn);
  border-radius:50%;
  width:46px;
  height:46px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
}

table{width:100%;border-collapse:collapse;font-size:13px}
td,th{border-bottom:1px solid var(--line);padding:6px}

input,textarea{
  background:var(--btn);
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:4px;
}

textarea{width:100%;resize:vertical}

</style>
</head>

<body>

<!-- TOP -->
<div class="top-row">
  <div class="card trip-card" id="tripTotCard">
    <div class="label">TRIP TOTALE</div>
    <div class="big" id="odoTot">0.000</div>
  </div>

  <div class="photo-btn" onclick="takePhoto()">ðŸ“·</div>
</div>

<!-- GPS -->
<div class="card gps-bar small">
  <button onclick="startGPS()">ðŸ“¡</button>
  <div class="gps-info">
    <span id="fix">FIX â€”</span>
    <span id="acc">Â±â€” m</span>
    <span id="time">â€”</span>
    <span id="hz">â€” Hz</span>
  </div>
  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<!-- MAP -->
<div class="card">
  <div id="map">
    <div id="recenter" onclick="recenter()">ðŸŽ¯</div>
  </div>
</div>

<!-- TRIP PARZIALE -->
<div class="card" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (tap = punto)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<!-- EXPORT -->
<div class="card">
  <button onclick="exportKMZ()">Export KMZ</button>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">

<script>
const state={
  watch:null,
  recording:false,
  last:null,
  lastFixTime:null,
  odoTot:0,
  odoParz:0,
  track:[],
  points:[],
  photos:[]
};

const map=L.map("map").setView([45,9],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const line=L.polyline([],{color:"#4dd4ac"}).addTo(map);

function recenter(){ if(state.last) map.setView([state.last.lat,state.last.lon],16); }

function startGPS(){
  if(state.watch) navigator.geolocation.clearWatch(state.watch);
  state.recording=false;
  updateRecUI();
  state.watch=navigator.geolocation.watchPosition(pos=>{
    const {latitude:lat,longitude:lon,accuracy}=pos.coords;
    const now=Date.now();
    document.getElementById("fix").textContent="FIX OK";
    document.getElementById("acc").textContent="Â±"+Math.round(accuracy)+" m";
    document.getElementById("time").textContent=new Date().toLocaleTimeString();
    if(state.lastFixTime){
      document.getElementById("hz").textContent=(1/((now-state.lastFixTime)/1000)).toFixed(1)+" Hz";
    }
    state.lastFixTime=now;
    if(state.last && state.recording){
      const d=haversine(state.last.lat,state.last.lon,lat,lon);
      state.odoTot+=d;
      state.odoParz+=d;
      updateTrips();
      line.addLatLng([lat,lon]);
    }
    state.last={lat,lon,time:new Date()};
    state.track.push(state.last);
  },()=>{}, {enableHighAccuracy:true});
}

function toggleRec(){
  state.recording=!state.recording;
  updateRecUI();
}

function updateRecUI(){
  const b=document.getElementById("recBtn");
  b.textContent=state.recording?"REC":"PAUSA";
  b.className=state.recording?"rec":"pause";
}

function updateTrips(){
  document.getElementById("odoTot").textContent=state.odoTot.toFixed(3);
  document.getElementById("odoParz").textContent=state.odoParz.toFixed(3);
}

function addPoint(){
  if(!state.last) return;
  state.odoParz=0;
  updateTrips();
}

function takePhoto(){
  if(!state.last){
    alert("GPS non disponibile");
    return;
  }
  document.getElementById("cameraInput").click();
}

document.getElementById("cameraInput").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const photo={
      lat:state.last.lat,
      lon:state.last.lon,
      img:reader.result,
      desc:""
    };
    state.photos.push(photo);

    const marker=L.marker([photo.lat,photo.lon]).addTo(map);
    marker.bindPopup(()=>{
      const div=document.createElement("div");
      div.innerHTML=`
        <img src="${photo.img}" style="width:200px"><br>
        <textarea placeholder="Descrizione foto">${photo.desc}</textarea>
      `;
      const ta=div.querySelector("textarea");
      ta.onchange=()=>photo.desc=ta.value;
      return div;
    });
  };
  reader.readAsDataURL(file);
});

function exportKMZ(){
  const zip=new JSZip();
  let kml=`<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Roadbook</name>`;

  state.photos.forEach((p,i)=>{
    const imgName=`photo${i}.jpg`;
    const base64=p.img.split(",")[1];
    zip.file(imgName,base64,{base64:true});
    kml+=`
<Placemark>
<name>Foto ${i+1}</name>
<description><![CDATA[${p.desc}<br><img src="${imgName}" width="300">]]></description>
<Point><coordinates>${p.lon},${p.lat},0</coordinates></Point>
</Placemark>`;
  });

  kml+=`</Document></kml>`;
  zip.file("doc.kml",kml);

  zip.generateAsync({type:"blob"}).then(blob=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="roadbook.kmz";
    a.click();
  });
}

function haversine(a,b,c,d){
  const R=6371;
  const r=x=>x*Math.PI/180;
  const x=Math.sin(r(c-a)/2)**2+Math.cos(r(a))*Math.cos(r(c))*Math.sin(r(d-b)/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>
</body>
</html>
