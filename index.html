<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roadbook Logger</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --card:#121826;
  --muted:#9fb0c3;
  --btn:#1b2536;
  --line:#223;
  --ok:#4dd4ac;
  --warn:#ffcc66;
}

body{margin:0;background:var(--bg);color:#e8eef6;font-family:system-ui}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px}
.big{
  font-size:56px;
  font-family:monospace;
  line-height:1;
  text-align:right;
  padding-right:2ch; /* richiesto: rientro 2 */
}
.label{font-size:11px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

button{
  background:var(--btn);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:12px;
  white-space:nowrap;
}

.gps-bar{
  display:flex;
  align-items:center;
  gap:8px;
}

.gps-info{
  flex:1;
  display:flex;
  gap:10px;
  justify-content:center;
  white-space:nowrap;
  overflow:hidden;
}

#recBtn.rec{color:var(--ok)}
#recBtn.pause{color:var(--warn)}

#map{
  height:320px;
  border-radius:14px;
  position:relative;
}

#recenter{
  position:absolute;
  bottom:12px;
  right:12px;
  z-index:2000;
  background:var(--btn);
  border-radius:50%;
  width:46px;
  height:46px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  pointer-events:auto;
}

table{width:100%;border-collapse:collapse;font-size:13px}
td,th{border-bottom:1px solid var(--line);padding:6px;vertical-align:middle}
thead th{color:var(--muted);font-weight:600}

tbody tr{cursor:pointer}
tbody tr.active{
  outline:1px solid rgba(77,212,172,.45);
  outline-offset:-1px;
  background:rgba(77,212,172,.06);
}

input{
  width:64px;
  background:var(--btn);
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:4px;
}

.input-att{width:44px} /* att piÃ¹ stretto */

.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:#0e1522;
  border:1px solid var(--line);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  font-size:13px;
  max-width:92vw;
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
}
.toast.show{opacity:1}
</style>
</head>

<body>

<!-- TRIP TOTALE (tap lungo 3s = reset) -->
<div class="card" id="tripTotCard">
  <div class="label">TRIP TOTALE (tap lungo 3s = azzera)</div>
  <div class="big" id="odoTot">0.000</div>
</div>

<!-- GPS BAR -->
<div class="card gps-bar small">
  <button onclick="startGPS()">ðŸ“¡</button>

  <div class="gps-info">
    <span id="fix">FIX â€”</span>
    <span id="acc">Â±â€” m</span>
    <span id="time">â€”</span>
    <span id="hz">â€” Hz</span>
  </div>

  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<!-- MAP -->
<div class="card">
  <div id="map">
    <div id="recenter" onclick="recenter()">ðŸŽ¯</div>
  </div>
</div>

<!-- TRIP PARZIALE -->
<div class="card" style="cursor:pointer" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (tap = punto)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<!-- POINTS -->
<div class="card">
<table>
<thead>
<tr>
  <th>#</th>
  <th>KM Tot</th>
  <th>KM Parz</th>
  <th>Ora</th>
  <th>Att</th>
  <th>PreRil</th>
</tr>
</thead>
<tbody id="points"></tbody>
</table>
</div>

<!-- EXPORT -->
<div class="card">
  <button onclick="exportCSV()">Export Excel</button>
  <button onclick="exportGPX()">Export GPX</button>
  <button onclick="exportKMZ()">Export KMZ</button>
</div>

<div id="toast" class="toast"></div>

<script>
/* =======================
   Stato
======================= */
const state={
  watch:null,
  recording:false,          // richiesto: parte in PAUSA quando attivi GPS
  last:null,
  lastFixTime:null,
  odoTot:0,
  odoParz:0,
  track:[],
  points:[],                // ultimo in alto (unshift)
  markersById:new Map(),    // id -> Leaflet marker
  activeId:null,
  nextId:1
};

/* =======================
   Mappa
======================= */
const map=L.map("map").setView([45,9],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const line=L.polyline([],{color:"#4dd4ac"}).addTo(map);

function recenter(){
  if(state.last) map.setView([state.last.lat,state.last.lon],16);
}

/* =======================
   Helper
======================= */
function toast(msg,ms=1200){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>el.classList.remove("show"),ms);
}

function haversine(a,b,c,d){
  const R=6371;
  const r=x=>x*Math.PI/180;
  const x=Math.sin(r(c-a)/2)**2+
          Math.cos(r(a))*Math.cos(r(c))*Math.sin(r(d-b)/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function updateTripsUI(){
  document.getElementById("odoTot").textContent=state.odoTot.toFixed(3);
  document.getElementById("odoParz").textContent=state.odoParz.toFixed(3);
}

function escXml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&apos;");
}

/* =======================
   GPS
======================= */
function startGPS(){
  if(state.watch) navigator.geolocation.clearWatch(state.watch);

  state.recording=false;     // richiesto
  updateRecUI();

  state.watch=navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat,longitude:lon,accuracy}=pos.coords;
      const now=Date.now();

      document.getElementById("fix").textContent="FIX OK";
      document.getElementById("acc").textContent="Â±"+Math.round(accuracy)+" m";
      document.getElementById("time").textContent=new Date().toLocaleTimeString();

      if(state.lastFixTime){
        const dt=(now-state.lastFixTime)/1000;
        const hz=dt>0 ? (1/dt) : 0;
        document.getElementById("hz").textContent=hz.toFixed(1)+" Hz";
      }
      state.lastFixTime=now;

      if(state.last && state.recording){
        const d=haversine(state.last.lat,state.last.lon,lat,lon);
        state.odoTot+=d;
        state.odoParz+=d;
        updateTripsUI();
        line.addLatLng([lat,lon]);
      }

      state.last={lat,lon,time:new Date()};
      state.track.push(state.last);
    },
    ()=>{
      document.getElementById("fix").textContent="ERRORE GPS";
    },
    {enableHighAccuracy:true,maximumAge:0}
  );

  toast("GPS avviato (PAUSA)");
}

function toggleRec(){
  state.recording=!state.recording;
  updateRecUI();
  toast(state.recording ? "REC attivo" : "PAUSA");
}

function updateRecUI(){
  const b=document.getElementById("recBtn");
  if(state.recording){
    b.textContent="REC";
    b.className="rec";
  }else{
    b.textContent="PAUSA";
    b.className="pause";
  }
}

/* =======================
   Punti
======================= */
function addPoint(){
  if(!state.last) return;

  const id=state.nextId++;
  const p={
    id,
    kmTot:state.odoTot,
    kmParz:state.odoParz,
    lat:state.last.lat,
    lon:state.last.lon,
    time:state.last.time.toLocaleTimeString(),
    preril:"",
    att:""
  };

  state.points.unshift(p);

  const m=L.marker([p.lat,p.lon]).addTo(map);
  m.on("click",()=>{
    selectPoint(p.id,{centerMap:false,scrollRow:true});
  });
  state.markersById.set(p.id,m);

  state.odoParz=0;
  updateTripsUI();

  renderPoints();
  toast(`Punto ${p.id} rilevato`);
}

function renderPoints(){
  const tb=document.getElementById("points");
  tb.innerHTML="";

  state.points.forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.dataset.id=p.id;

    tr.innerHTML=`
      <td>${p.id}</td>
      <td>${p.kmTot.toFixed(3)}</td>
      <td>${p.kmParz.toFixed(3)}</td>
      <td>${p.time}</td>
      <td><input class="input-att" value="${escXml(p.att)}" onchange="state.points[${i}].att=this.value"></td>
      <td><input value="${escXml(p.preril)}" onchange="state.points[${i}].preril=this.value"></td>
    `;

    tr.addEventListener("click",()=>{
      selectPoint(p.id,{centerMap:true,scrollRow:false});
    });

    tb.appendChild(tr);
  });

  highlightTable();
}

function highlightTable(){
  const tb=document.getElementById("points");
  [...tb.querySelectorAll("tr")].forEach(tr=>{
    tr.classList.toggle("active", Number(tr.dataset.id)===state.activeId);
  });
}

function scrollRowToActive(){
  const tb=document.getElementById("points");
  const tr=tb.querySelector(`tr[data-id="${state.activeId}"]`);
  if(tr) tr.scrollIntoView({block:"nearest", behavior:"smooth"});
}

function selectPoint(id,{centerMap,scrollRow}){
  state.activeId=id;
  highlightTable();

  const p=state.points.find(x=>x.id===id);
  const m=state.markersById.get(id);

  if(centerMap && p){
    map.setView([p.lat,p.lon],16);
  }

  if(m){
    m.bindPopup(String(id)).openPopup(); // richiesto: niente P1, solo "1"
  }

  if(scrollRow) scrollRowToActive();
}

/* =======================
   Export
======================= */
function exportCSV(){
  function toDec(v){ return v.toFixed(6).replace(".",","); }

  function toGM(val,isLat){
    const dir = isLat ? (val>=0 ? "N" : "S") : (val>=0 ? "E" : "W");
    const abs = Math.abs(val);
    const deg = Math.floor(abs);
    const min = ((abs - deg) * 60).toFixed(3);
    return `${dir}${deg} ${min}`;
  }

  let csv = "ID;KM_TOT;KM_PARZ;LAT_DEC;LON_DEC;LAT_GM;LON_GM;ORA;ATT;PRERIL\n";

  state.points.forEach(p => {
    const kmTot = p.kmTot.toFixed(3).replace(".",",");
    const kmParz = p.kmParz.toFixed(3).replace(".",",");
    const latDec = toDec(p.lat);
    const lonDec = toDec(p.lon);
    const latGM = toGM(p.lat,true);
    const lonGM = toGM(p.lon,false);
    csv += `${p.id};${kmTot};${kmParz};${latDec};${lonDec};${latGM};${lonGM};${p.time};${p.att};${p.preril}\n`;
  });

  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "roadbook_export.csv";
  a.click();
}

function exportGPX(){
  let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n`;
  gpx+=`<gpx version="1.1" creator="Roadbook Logger" xmlns="http://www.topografix.com/GPX/1/1">\n`;
  gpx+=`  <trk><name>Track</name><trkseg>\n`;
  state.track.forEach(p=>{
    gpx+=`    <trkpt lat="${p.lat}" lon="${p.lon}"></trkpt>\n`;
  });
  gpx+=`  </trkseg></trk>\n`;

  // punti come waypoint
  state.points.slice().reverse().forEach(p=>{
    gpx+=`  <wpt lat="${p.lat}" lon="${p.lon}"><name>${p.id}</name></wpt>\n`;
  });

  gpx+=`</gpx>`;
  download("track.gpx",gpx,"application/gpx+xml");
}

async function exportKMZ(){
  const kml=buildKML();
  const zip=new JSZip();
  zip.file("doc.kml",kml);
  const blob=await zip.generateAsync({type:"blob",compression:"DEFLATE"});
  downloadBlob("track.kmz",blob);
}

function buildKML(){
  const coords=state.track.map(p=>`${p.lon},${p.lat},0`).join(" ");

  const pointsKml=state.points.slice().reverse().map(p=>{
    const descParts=[
      `KM Tot: ${p.kmTot.toFixed(3)}`,
      `KM Parz: ${p.kmParz.toFixed(3)}`,
      `Ora: ${escXml(p.time)}`,
      `Att: ${escXml(p.att)}`,
      `PreRil: ${escXml(p.preril)}`
    ].join("<br/>");

    return `
    <Placemark>
      <name>${p.id}</name>
      <description><![CDATA[${descParts}]]></description>
      <Point><coordinates>${p.lon},${p.lat},0</coordinates></Point>
    </Placemark>`;
  }).join("\n");

  return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Roadbook Logger</name>

    <Style id="trackStyle">
      <LineStyle>
        <color>ffacd44d</color>
        <width>4</width>
      </LineStyle>
    </Style>

    <Placemark>
      <name>Track</name>
      <styleUrl>#trackStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>${coords}</coordinates>
      </LineString>
    </Placemark>

    ${pointsKml}
  </Document>
</kml>`;
}

function download(filename,content,mime){
  const blob=new Blob([content],{type:mime || "application/octet-stream"});
  downloadBlob(filename,blob);
}

function downloadBlob(filename,blob){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}

/* =======================
   Long press 3s per azzerare Trip Totale
======================= */
(function setupLongPressResetTot(){
  const card=document.getElementById("tripTotCard");
  let timer=null;
  let pressed=false;

  function start(e){
    pressed=true;
    clearTimeout(timer);
    timer=setTimeout(()=>{
      if(!pressed) return;

      state.odoTot=0;
      state.odoParz=0;
      updateTripsUI();

      // reset traccia visiva (non cancella track array, cosÃ¬ se vuoi esportare resta)
      line.setLatLngs([]);

      if(navigator.vibrate) navigator.vibrate(80);
      toast("Trip totale azzerato");
    },3000);

    if(e && e.cancelable) e.preventDefault();
  }

  function end(){
    pressed=false;
    clearTimeout(timer);
  }

  card.addEventListener("touchstart",start,{passive:false});
  card.addEventListener("touchend",end);
  card.addEventListener("touchcancel",end);

  card.addEventListener("mousedown",start);
  card.addEventListener("mouseup",end);
  card.addEventListener("mouseleave",end);
})();
</script>
</body>
</html>

