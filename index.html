<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roadbook Logger</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --card:#121826;
  --muted:#9fb0c3;
  --btn:#1b2536;
  --line:#223;
  --ok:#4dd4ac;
  --warn:#ffcc66;
}

body{margin:0;background:var(--bg);color:#e8eef6;font-family:system-ui}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px}
.big{
  font-size:56px;
  font-family:monospace;
  line-height:1;
  text-align:right;
  padding-right:3ch;
}
.label{font-size:11px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

button{
  background:var(--btn);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:12px;
  white-space:nowrap;
}

.gps-bar{
  display:flex;
  align-items:center;
  gap:8px;
}

.gps-info{
  flex:1;
  display:flex;
  gap:10px;
  justify-content:center;
  white-space:nowrap;
  overflow:hidden;
}

#recBtn.rec{color:var(--ok)}
#recBtn.pause{color:var(--warn)}

#map{
  height:320px;
  border-radius:14px;
  position:relative;
}

#recenter{
  position:absolute;
  bottom:12px;
  right:12px;
  z-index:2000;           /* sempre sopra la mappa */
  background:var(--btn);
  border-radius:50%;
  width:46px;
  height:46px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  pointer-events:auto;
}

table{width:100%;border-collapse:collapse;font-size:13px}
td,th{border-bottom:1px solid var(--line);padding:6px;vertical-align:middle}

input{
  width:60px;
  background:var(--btn);
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:4px;
}

.hidden{display:none}

.timeline{
  list-style:none;
  padding-left:0;
  margin:10px 0 0 0;
}

.timeline li{
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  margin:6px 0;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  display:flex;
  justify-content:space-between;
  gap:10px;
}

.timeline li .t-left{display:flex;gap:10px;align-items:baseline}
.timeline li .t-id{font-family:monospace}
.timeline li .t-km{font-family:monospace;color:#e8eef6}
.timeline li .t-time{color:var(--muted);font-size:12px}

.timeline li.active{
  border-color:var(--ok);
  box-shadow:0 0 0 1px rgba(77,212,172,.25) inset;
}

.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:#0e1522;
  border:1px solid var(--line);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  font-size:13px;
  max-width:92vw;
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
}
.toast.show{opacity:1}
</style>
</head>

<body>

<!-- TRIP TOTALE (tap lungo 3s = reset) -->
<div class="card" id="tripTotCard">
  <div class="label">TRIP TOTALE (tap lungo 3s = azzera)</div>
  <div class="big" id="odoTot">0.000</div>
</div>

<!-- GPS BAR -->
<div class="card gps-bar small">
  <button onclick="startGPS()">ðŸ“¡</button>

  <div class="gps-info">
    <span id="fix">FIX â€”</span>
    <span id="acc">Â±â€” m</span>
    <span id="time">â€”</span>
    <span id="hz">â€” Hz</span>
  </div>

  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<!-- MAP -->
<div class="card">
  <div id="map">
    <div id="recenter" onclick="recenter()">ðŸŽ¯</div>
  </div>
</div>

<!-- TRIP PARZIALE -->
<div class="card" style="cursor:pointer" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (tap = punto)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<!-- TIMELINE -->
<div class="card">
  <button onclick="toggleTimeline()">Timeline</button>
  <ul id="timeline" class="timeline hidden"></ul>
</div>

<!-- POINTS -->
<div class="card">
<table>
<thead>
<tr>
<th>#</th><th>KM Tot</th><th>KM Parz</th><th>Lat</th><th>Lon</th><th>Ora</th><th>PreRil</th>
</tr>
</thead>
<tbody id="points"></tbody>
</table>
</div>

<!-- EXPORT -->
<div class="card">
<button onclick="exportCSV()">Export Excel</button>
<button onclick="exportGPX()">Export GPX</button>
</div>

<div id="toast" class="toast"></div>

<script>
/* =======================
   Stato
======================= */
const state={
  watch:null,
  recording:false,          // importante: parte in PAUSA
  last:null,
  lastFixTime:null,
  odoTot:0,
  odoParz:0,
  track:[],
  points:[],                // ultimo in alto (unshift)
  timeline:[],
  markersById:new Map(),    // id -> Leaflet marker
  activeId:null
};

/* =======================
   Mappa
======================= */
const map=L.map("map").setView([45,9],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const line=L.polyline([],{color:"#4dd4ac"}).addTo(map);

function recenter(){
  if(state.last) map.setView([state.last.lat,state.last.lon],16);
}

/* =======================
   Helper
======================= */
function toast(msg,ms=1200){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>el.classList.remove("show"),ms);
}

function haversine(a,b,c,d){
  const R=6371;
  const r=x=>x*Math.PI/180;
  const x=Math.sin(r(c-a)/2)**2+
          Math.cos(r(a))*Math.cos(r(c))*Math.sin(r(d-b)/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function updateTripsUI(){
  document.getElementById("odoTot").textContent=state.odoTot.toFixed(3);
  document.getElementById("odoParz").textContent=state.odoParz.toFixed(3);
}

/* =======================
   GPS
======================= */
function startGPS(){
  if(state.watch) navigator.geolocation.clearWatch(state.watch);

  // richiesta tua: quando avvio GPS, il tool deve essere in PAUSA
  state.recording=false;
  updateRecUI();

  state.watch=navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat,longitude:lon,accuracy}=pos.coords;
      const now=Date.now();

      document.getElementById("fix").textContent="FIX OK";
      document.getElementById("acc").textContent="Â±"+Math.round(accuracy)+" m";
      document.getElementById("time").textContent=new Date().toLocaleTimeString();

      if(state.lastFixTime){
        const dt=(now-state.lastFixTime)/1000;
        const hz=dt>0 ? (1/dt) : 0;
        document.getElementById("hz").textContent=hz.toFixed(1)+" Hz";
      }
      state.lastFixTime=now;

      if(state.last && state.recording){
        const d=haversine(state.last.lat,state.last.lon,lat,lon);
        state.odoTot+=d;
        state.odoParz+=d;
        updateTripsUI();
        line.addLatLng([lat,lon]);
      }

      state.last={lat,lon,time:new Date()};
      state.track.push(state.last);
    },
    ()=>{
      document.getElementById("fix").textContent="ERRORE GPS";
    },
    {enableHighAccuracy:true,maximumAge:0}
  );

  toast("GPS avviato (PAUSA)");
}

function toggleRec(){
  state.recording=!state.recording;
  updateRecUI();
  toast(state.recording ? "REC attivo" : "PAUSA");
}

function updateRecUI(){
  const b=document.getElementById("recBtn");
  if(state.recording){
    b.textContent="REC";
    b.className="rec";
  }else{
    b.textContent="PAUSA";
    b.className="pause";
  }
}

/* =======================
   Punti + timeline + marker
======================= */
function addPoint(){
  if(!state.last) return;

  const p={
    id:state.points.length+1,
    kmTot:state.odoTot,
    kmParz:state.odoParz,
    lat:state.last.lat,
    lon:state.last.lon,
    time:state.last.time.toLocaleTimeString(),
    preril:""
  };

  // ultimo in alto
  state.points.unshift(p);
  state.timeline.unshift({ id:p.id, kmTot:p.kmTot, time:p.time });

  // marker
  const m=L.marker([p.lat,p.lon]).addTo(map);
  m.on("click",()=>{
    selectPoint(p.id, {centerMap:false, openTimeline:true, scrollTimeline:true});
  });
  state.markersById.set(p.id,m);

  // reset parziale
  state.odoParz=0;
  updateTripsUI();

  renderPoints();
  renderTimeline();

  toast(`Punto ${p.id} rilevato`);
}

function renderTimeline(){
  const ul=document.getElementById("timeline");
  ul.innerHTML="";

  state.timeline.forEach(item=>{
    const li=document.createElement("li");
    li.dataset.id=item.id;

    const left=document.createElement("div");
    left.className="t-left";
    left.innerHTML=`<span class="t-id">P${item.id}</span><span class="t-km">${item.kmTot.toFixed(3)}</span>`;

    const right=document.createElement("div");
    right.className="t-time";
    right.textContent=item.time;

    li.appendChild(left);
    li.appendChild(right);

    li.addEventListener("click",()=>{
      selectPoint(item.id, {centerMap:true, openTimeline:true, scrollTimeline:false});
    });

    ul.appendChild(li);
  });

  highlightTimeline();
}

function highlightTimeline(){
  const ul=document.getElementById("timeline");
  [...ul.querySelectorAll("li")].forEach(li=>{
    li.classList.toggle("active", Number(li.dataset.id)===state.activeId);
  });
}

function scrollTimelineToActive(){
  const ul=document.getElementById("timeline");
  const li=ul.querySelector(`li[data-id="${state.activeId}"]`);
  if(li) li.scrollIntoView({block:"nearest", behavior:"smooth"});
}

function selectPoint(id,{centerMap,openTimeline,scrollTimeline}){
  state.activeId=id;

  // evidenzia timeline
  highlightTimeline();

  // apri timeline se serve
  if(openTimeline){
    document.getElementById("timeline").classList.remove("hidden");
  }

  // centro mappa sul punto
  if(centerMap){
    const p=state.points.find(x=>x.id===id);
    if(p) map.setView([p.lat,p.lon],16);
  }

  // evidenzia marker (popup semplice)
  const m=state.markersById.get(id);
  if(m){
    m.bindPopup(`P${id}`).openPopup();
  }

  if(scrollTimeline) scrollTimelineToActive();
}

function renderPoints(){
  const tb=document.getElementById("points");
  tb.innerHTML="";

  state.points.forEach((p,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${p.id}</td>
        <td>${p.kmTot.toFixed(3)}</td>
        <td>${p.kmParz.toFixed(3)}</td>
        <td>${p.lat.toFixed(6)}</td>
        <td>${p.lon.toFixed(6)}</td>
        <td>${p.time}</td>
        <td><input value="${p.preril}" onchange="state.points[${i}].preril=this.value"></td>
      </tr>
    `;
  });
}

/* =======================
   Timeline toggle
======================= */
function toggleTimeline(){
  document.getElementById("timeline").classList.toggle("hidden");
}

/* =======================
   Export
======================= */
function exportCSV(){
  // richiesta: lat/lon restano nellâ€™excel, timeline invece semplificata
  let csv="ID;KM_TOT;KM_PARZ;LAT;LON;ORA;PRERIL\n";
  state.points.forEach(p=>{
    csv+=`${p.id};${p.kmTot};${p.kmParz};${p.lat};${p.lon};${p.time};${p.preril}\n`;
  });
  download("roadbook.csv",csv);
}

function exportGPX(){
  let gpx=`<?xml version="1.0"?><gpx version="1.1"><trk><trkseg>`;
  state.track.forEach(p=>{
    gpx+=`<trkpt lat="${p.lat}" lon="${p.lon}"></trkpt>`;
  });
  gpx+=`</trkseg></trk></gpx>`;
  download("track.gpx",gpx);
}

function download(n,t){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([t]));
  a.download=n;
  a.click();
}

/* =======================
   Long press 3s per azzerare Trip Totale
======================= */
(function setupLongPressResetTot(){
  const card=document.getElementById("tripTotCard");
  let timer=null;
  let pressed=false;

  function start(e){
    pressed=true;
    clearTimeout(timer);
    timer=setTimeout(()=>{
      if(!pressed) return;

      state.odoTot=0;
      state.odoParz=0;
      updateTripsUI();

      // reset anche la polilinea, ma NON cancello i punti rilevati (li hai giÃ  segnati)
      line.setLatLngs([]);

      if(navigator.vibrate) navigator.vibrate(80);
      toast("Trip totale azzerato");
    },3000);

    // evita scroll/drag involontario sul long press
    if(e && e.cancelable) e.preventDefault();
  }

  function end(){
    pressed=false;
    clearTimeout(timer);
  }

  card.addEventListener("touchstart",start,{passive:false});
  card.addEventListener("touchend",end);
  card.addEventListener("touchcancel",end);

  card.addEventListener("mousedown",start);
  card.addEventListener("mouseup",end);
  card.addEventListener("mouseleave",end);
})();
</script>
</body>
</html>
