<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roadbook Logger</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0b0f14;color:#e8eef6;font-family:system-ui}
.card{background:#121826;border-radius:14px;padding:10px;margin:8px}
.big{font-size:56px;font-family:monospace;line-height:1}
.label{font-size:11px;color:#9fb0c3}
.small{font-size:12px;color:#9fb0c3}

button{
  background:#1b2536;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:12px;
}

.gps-bar{
  display:flex;
  align-items:center;
  gap:8px;
}

.gps-info{
  flex:1;
  display:flex;
  gap:10px;
  justify-content:center;
  white-space:nowrap;
}

#recBtn.rec{color:#4dd4ac}
#recBtn.pause{color:#ffcc66}

#map{
  height:320px;
  border-radius:14px;
  position:relative;
}

#recenter{
  position:absolute;
  bottom:12px;
  right:12px;
  z-index:1000;
  background:#1b2536;
  border-radius:50%;
  width:46px;
  height:46px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
}

table{width:100%;border-collapse:collapse;font-size:13px}
td,th{border-bottom:1px solid #223;padding:6px}

input{
  width:60px;
  background:#1b2536;
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:4px;
}

.hidden{display:none}
</style>
</head>

<body>

<!-- TRIP TOTALE -->
<div class="card">
  <div class="label">TRIP TOTALE</div>
  <div class="big" id="odoTot">0.000</div>
</div>

<!-- GPS BAR -->
<div class="card gps-bar small">
  <button onclick="startGPS()">ðŸ“¡</button>

  <div class="gps-info">
    <span id="fix">FIX â€”</span>
    <span id="acc">Â±â€” m</span>
    <span id="time">â€”</span>
    <span id="hz">â€” Hz</span>
  </div>

  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<!-- MAP -->
<div class="card">
  <div id="map">
    <div id="recenter" onclick="recenter()">ðŸŽ¯</div>
  </div>
</div>

<!-- TRIP PARZIALE -->
<div class="card" style="cursor:pointer" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (tap = punto)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<!-- TIMELINE -->
<div class="card">
  <button onclick="toggleTimeline()">Timeline</button>
  <ul id="timeline" class="hidden"></ul>
</div>

<!-- POINTS -->
<div class="card">
<table>
<thead>
<tr>
<th>#</th><th>KM Tot</th><th>KM Parz</th><th>Lat</th><th>Lon</th><th>Ora</th><th>PreRil</th>
</tr>
</thead>
<tbody id="points"></tbody>
</table>
</div>

<!-- EXPORT -->
<div class="card">
<button onclick="exportCSV()">Export Excel</button>
<button onclick="exportGPX()">Export GPX</button>
</div>

<script>
const state={
  watch:null,
  recording:true,
  last:null,
  lastFixTime:null,
  odoTot:0,
  odoParz:0,
  track:[],
  points:[],
  timeline:[]
};

const map=L.map("map").setView([45,9],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const line=L.polyline([],{color:"#4dd4ac"}).addTo(map);

function startGPS(){
  if(state.watch) navigator.geolocation.clearWatch(state.watch);
  state.recording=true;
  updateRecUI();

  state.watch=navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat,longitude:lon,accuracy}=pos.coords;
      const now=Date.now();

      document.getElementById("fix").textContent="FIX OK";
      document.getElementById("acc").textContent="Â±"+Math.round(accuracy)+" m";
      document.getElementById("time").textContent=new Date().toLocaleTimeString();

      if(state.lastFixTime){
        const dt=(now-state.lastFixTime)/1000;
        document.getElementById("hz").textContent=(1/dt).toFixed(1)+" Hz";
      }
      state.lastFixTime=now;

      if(state.last && state.recording){
        const d=haversine(state.last.lat,state.last.lon,lat,lon);
        state.odoTot+=d;
        state.odoParz+=d;
        document.getElementById("odoTot").textContent=state.odoTot.toFixed(3);
        document.getElementById("odoParz").textContent=state.odoParz.toFixed(3);
        line.addLatLng([lat,lon]);
      }

      state.last={lat,lon,time:new Date()};
      state.track.push(state.last);
    },
    ()=>{ document.getElementById("fix").textContent="ERRORE GPS"; },
    {enableHighAccuracy:true,maximumAge:0}
  );
}

function toggleRec(){
  state.recording=!state.recording;
  updateRecUI();
}

function updateRecUI(){
  const b=document.getElementById("recBtn");
  if(state.recording){
    b.textContent="REC";
    b.className="rec";
  }else{
    b.textContent="PAUSA";
    b.className="pause";
  }
}

function addPoint(){
  if(!state.last) return;
  const p={
    id:state.points.length+1,
    kmTot:state.odoTot,
    kmParz:state.odoParz,
    lat:state.last.lat,
    lon:state.last.lon,
    time:state.last.time.toLocaleTimeString(),
    preril:""
  };
  state.points.unshift(p);
  state.timeline.unshift("P"+p.id+" @ "+p.kmTot.toFixed(3));
  state.odoParz=0;
  document.getElementById("odoParz").textContent="0.000";
  renderPoints();renderTimeline();
}

function renderPoints(){
  const tb=document.getElementById("points");
  tb.innerHTML="";
  state.points.forEach((p,i)=>{
    tb.innerHTML+=`
    <tr>
      <td>${p.id}</td>
      <td>${p.kmTot.toFixed(3)}</td>
      <td>${p.kmParz.toFixed(3)}</td>
      <td>${p.lat.toFixed(6)}</td>
      <td>${p.lon.toFixed(6)}</td>
      <td>${p.time}</td>
      <td><input value="${p.preril}" onchange="state.points[${i}].preril=this.value"></td>
    </tr>`;
  });
}

function toggleTimeline(){
  document.getElementById("timeline").classList.toggle("hidden");
}

function renderTimeline(){
  const ul=document.getElementById("timeline");
  ul.innerHTML="";
  state.timeline.forEach(e=>ul.innerHTML+="<li>"+e+"</li>");
}

function recenter(){
  if(state.last) map.setView([state.last.lat,state.last.lon],16);
}

function exportCSV(){
  let csv="ID;KM_TOT;KM_PARZ;LAT;LON;ORA;PRERIL\n";
  state.points.forEach(p=>{
    csv+=`${p.id};${p.kmTot};${p.kmParz};${p.lat};${p.lon};${p.time};${p.preril}\n`;
  });
  download("roadbook.csv",csv);
}

function exportGPX(){
  let gpx=`<?xml version="1.0"?><gpx version="1.1"><trk><trkseg>`;
  state.track.forEach(p=>{
    gpx+=`<trkpt lat="${p.lat}" lon="${p.lon}"></trkpt>`;
  });
  gpx+=`</trkseg></trk></gpx>`;
  download("track.gpx",gpx);
}

function download(n,t){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([t]));
  a.download=n;a.click();
}

function haversine(a,b,c,d){
  const R=6371;
  const r=x=>x*Math.PI/180;
  const x=Math.sin(r(c-a)/2)**2+
          Math.cos(r(a))*Math.cos(r(c))*Math.sin(r(d-b)/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>
</body>
</html>
