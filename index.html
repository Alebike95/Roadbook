<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roadbook Logger</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --card:#121826;
  --muted:#9fb0c3;
  --btn:#1b2536;
  --line:#223;
  --ok:#4dd4ac;
  --warn:#ffcc66;
}

body{margin:0;background:var(--bg);color:#e8eef6;font-family:system-ui}
.card{background:var(--card);border-radius:14px;padding:10px;margin:8px}

.top-row{display:flex;gap:8px}
.trip-card{flex:1}
.photo-btn{
  width:56px;background:var(--btn);border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  font-size:26px;cursor:pointer
}

.big{font-size:56px;font-family:monospace;text-align:right;padding-right:2ch}
.label{font-size:11px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

button{
  background:var(--btn);color:#fff;border:none;border-radius:8px;
  padding:6px 10px;font-size:12px
}

.gps-bar{display:flex;gap:8px;align-items:center}
.gps-info{flex:1;display:flex;gap:10px;justify-content:center}

#recBtn.rec{color:var(--ok)}
#recBtn.pause{color:var(--warn)}

#map{height:320px;border-radius:14px}

table{width:100%;border-collapse:collapse;font-size:13px}
td,th{border-bottom:1px solid var(--line);padding:6px}
thead th{color:var(--muted)}
tbody tr.active{background:rgba(77,212,172,.08)}

input{
  background:var(--btn);color:#fff;border:1px solid #333;
  border-radius:6px;padding:4px
}

.trash{
  cursor:pointer;
  font-size:16px;
  text-align:center;
}

.photo-pin{
  width:28px;height:28px;border-radius:50%;
  background:#2b66ff;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:16px
}
</style>
</head>

<body>

<div class="top-row">
  <div class="card trip-card" id="tripTotCard">
    <div class="label">TRIP TOTALE (tap lungo 3s = azzera)</div>
    <div class="big" id="odoTot">0.000</div>
  </div>
  <div class="photo-btn" onclick="takePhoto()">üì∑</div>
</div>

<div class="card gps-bar small">
  <button onclick="startGPS()">üì°</button>
  <div class="gps-info">
    <span id="fix">FIX ‚Äî</span>
    <span id="acc">¬±‚Äî m</span>
    <span id="time">‚Äî</span>
    <span id="hz">‚Äî Hz</span>
  </div>
  <button id="recBtn" class="pause" onclick="toggleRec()">PAUSA</button>
</div>

<div class="card">
  <div id="map"></div>
</div>

<div class="card" onclick="addPoint()">
  <div class="label">TRIP PARZIALE (tap = punto)</div>
  <div class="big" id="odoParz">0.000</div>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>#</th>
  <th>KM Tot</th>
  <th>KM Parz</th>
  <th>Ora</th>
  <th>Att</th>
  <th>PreRil</th>
  <th>üóëÔ∏è</th>
</tr>
</thead>
<tbody id="points"></tbody>
</table>
</div>

<div class="card">
  <button onclick="exportCSV()">Export Excel</button>
  <button onclick="exportGPX()">Export GPX</button>
  <button onclick="exportKMZ()">Export KMZ</button>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">

<script>
/* =======================
   STATO
======================= */
const state={
  watchId:null,
  recording:false,
  lastFix:null,
  lastFixTimeMs:null,

  odoTotKm:0,
  odoParzKm:0,

  trackSegments:[],
  currentSegment:null,
  trackLines:[],

  points:[],
  photos:[],

  markerByPoint:new Map()
};

/* =======================
   MAPPA
======================= */
const map=L.map("map").setView([45,9],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* =======================
   GPS
======================= */
function startGPS(){
  if(state.watchId) navigator.geolocation.clearWatch(state.watchId);
  state.recording=false;
  updateRecUI();

  state.watchId=navigator.geolocation.watchPosition(onFix,()=>{},{
    enableHighAccuracy:true,maximumAge:0
  });
}

function onFix(pos){
  const lat=pos.coords.latitude;
  const lon=pos.coords.longitude;
  const now=Date.now();

  state.lastFix={lat,lon,timeMs:now};

  if(state.recording && state.currentSegment){
    const seg=state.currentSegment;
    const last=seg[seg.length-1];
    if(last){
      const d=haversineKm(last.lat,last.lon,lat,lon);
      state.odoTotKm+=d;
      state.odoParzKm+=d;
      updateTrips();
    }
    seg.push({lat,lon,timeMs:now});
    state.trackLines[state.trackLines.length-1].addLatLng([lat,lon]);
  }
}

function toggleRec(){
  state.recording=!state.recording;
  updateRecUI();

  if(state.recording){
    state.currentSegment=[];
    state.trackSegments.push(state.currentSegment);
    const line=L.polyline([],{color:"#4dd4ac",weight:4}).addTo(map);
    state.trackLines.push(line);
    if(state.lastFix){
      state.currentSegment.push(state.lastFix);
      line.addLatLng([state.lastFix.lat,state.lastFix.lon]);
    }
  }else{
    state.currentSegment=null;
  }
}

function updateRecUI(){
  const b=document.getElementById("recBtn");
  b.textContent=state.recording?"REC":"PAUSA";
  b.className=state.recording?"rec":"pause";
}

/* =======================
   PUNTI
======================= */
function addPoint(){
  if(!state.lastFix) return;

  const p={
    kmTot:state.odoTotKm,
    kmParz:state.odoParzKm,
    lat:state.lastFix.lat,
    lon:state.lastFix.lon,
    time:new Date().toLocaleTimeString(),
    att:"",
    preril:""
  };

  state.points.unshift(p);

  const m=L.circleMarker([p.lat,p.lon],{
    radius:8,fillColor:"#4dd4ac",fillOpacity:1,color:"#000"
  }).addTo(map);

  state.markerByPoint.set(p,m);

  state.odoParzKm=0;
  updateTrips();
  renderTable();
}

function deletePoint(index){
  const p=state.points[index];
  const m=state.markerByPoint.get(p);
  if(m) map.removeLayer(m);
  state.markerByPoint.delete(p);
  state.points.splice(index,1);
  renderTable();
}

function renderTable(){
  const tb=document.getElementById("points");
  tb.innerHTML="";
  state.points.forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${p.kmTot.toFixed(3)}</td>
      <td>${p.kmParz.toFixed(3)}</td>
      <td>${p.time}</td>
      <td><input value="${p.att}"></td>
      <td><input value="${p.preril}"></td>
      <td class="trash">üóëÔ∏è</td>
    `;
    tr.querySelector(".trash").onclick=()=>deletePoint(i);
    tb.appendChild(tr);
  });
}

/* =======================
   EXPORT
======================= */
function exportCSV(){
  let csv="N;KM_TOT;KM_PARZ;ORA;ATT;PRERIL\n";
  [...state.points].reverse().forEach((p,i)=>{
    csv+=`${i+1};${p.kmTot.toFixed(3)};${p.kmParz.toFixed(3)};${p.time};${p.att};${p.preril}\n`;
  });
  download("roadbook.csv",csv);
}

function exportGPX(){
  let gpx=`<?xml version="1.0"?><gpx><trk>`;
  state.trackSegments.forEach(seg=>{
    gpx+="<trkseg>";
    seg.forEach(p=>gpx+=`<trkpt lat="${p.lat}" lon="${p.lon}"/>`);
    gpx+="</trkseg>";
  });
  gpx+="</trk></gpx>";
  download("track.gpx",gpx);
}

function exportKMZ(){
  const zip=new JSZip();
  let kml=`<?xml version="1.0"?><kml><Document>`;
  state.trackSegments.forEach((seg,i)=>{
    const c=seg.map(p=>`${p.lon},${p.lat},0`).join(" ");
    kml+=`<Placemark><name>Track ${i+1}</name><LineString><coordinates>${c}</coordinates></LineString></Placemark>`;
  });
  kml+="</Document></kml>";
  zip.file("doc.kml",kml);
  zip.generateAsync({type:"blob"}).then(b=>downloadBlob("roadbook.kmz",b));
}

/* =======================
   UTIL
======================= */
function updateTrips(){
  document.getElementById("odoTot").textContent=state.odoTotKm.toFixed(3);
  document.getElementById("odoParz").textContent=state.odoParzKm.toFixed(3);
}

function haversineKm(a,b,c,d){
  const R=6371;
  const r=x=>x*Math.PI/180;
  const x=Math.sin(r(c-a)/2)**2+Math.cos(r(a))*Math.cos(r(c))*Math.sin(r(d-b)/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function download(name,text){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([text]));
  a.download=name;
  a.click();
}

function downloadBlob(name,blob){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}
</script>
</body>
</html>
